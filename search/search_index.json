{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Ghibli Movie Application","text":""},{"location":"#architecture-overview","title":"Architecture Overview","text":""},{"location":"#application-code-reference","title":"Application Code Reference","text":"<p>Ghibli Movie Booking System</p> <p>This Flask application provides a simple web interface for customers to log in, view their personal details and bookings, and update extra requests for courses.</p> <p>Note: This is a basic implementation with temporary in-memory data.</p>"},{"location":"#app.admin_dashboard","title":"<code>admin_dashboard()</code>","text":"<p>Display admin dashboard.</p> <p>Returns:</p> Name Type Description <code>str</code> <p>Rendered admin dashboard template</p> Source code in <code>app.py</code> <pre><code>@app.route(\"/admin\")\ndef admin_dashboard():\n    \"\"\"\n    Display admin dashboard.\n\n    Returns:\n        str: Rendered admin dashboard template\n    \"\"\"\n    return render_template(\"admin_dashboard.html\")\n</code></pre>"},{"location":"#app.booking","title":"<code>booking()</code>","text":"<p>Handle course booking. Fetches active courses and modules from DB for selection.</p> Source code in <code>app.py</code> <pre><code>@app.route(\"/book\", methods=[\"GET\", \"POST\"])\ndef booking():\n    \"\"\"\n    Handle course booking.\n    Fetches active courses and modules from DB for selection.\n    \"\"\"\n    if session.get(\"role\") != \"customer\":\n        return redirect(url_for(\"customer_login\"))\n\n    user_email = session.get(\"email\")\n\n    # --- POST REQUEST: Handle Form Submission ---\n    if request.method == \"POST\":\n        selected_course_ids = request.form.getlist(\"courses\")\n        extra_request = request.form.get(\"extra\", \"\")\n\n        if not selected_course_ids:\n            return redirect(url_for(\"booking\"))\n\n        new_booking_ids = []  # Track IDs of successfully created bookings\n\n        conn = None\n        try:\n            conn = get_db_connection()\n            cur = conn.cursor()\n\n            cur.execute(\"SELECT customer_id FROM customers WHERE email = %s\", (user_email,))\n            customer_row = cur.fetchone()\n            if not customer_row:\n                return redirect(url_for(\"customer_login\"))\n            customer_id = customer_row[0]\n\n            for course_id in selected_course_ids:\n                # Check duplicate\n                cur.execute(\n                    \"SELECT booking_id FROM bookings WHERE customer_id = %s AND course_id = %s\",\n                    (customer_id, course_id)\n                )\n                if cur.fetchone():\n                    continue\n\n                # Insert Booking\n                cur.execute(\n                    \"\"\"\n                    INSERT INTO bookings\n                    (customer_id, course_id, status, nice_to_have_requests, updated_at)\n                    VALUES (%s, %s, 'Pending', %s, NOW())\n                    RETURNING booking_id\n                    \"\"\",\n                    (customer_id, course_id, extra_request)\n                )\n                new_booking_id = cur.fetchone()[0]   # note a single item\n                new_booking_ids.append(new_booking_id)  # Add to a list\n\n                # Insert Modules\n                selected_module_ids = request.form.getlist(f\"modules_{course_id}\")\n                if selected_module_ids:\n                    module_insert_data = [(new_booking_id, m_id) for m_id in selected_module_ids]\n                    cur.executemany(\n                        \"INSERT INTO booking_modules (booking_id, module_id) VALUES (%s, %s)\",\n                        module_insert_data\n                    )\n\n            conn.commit()\n            # send ids to submitted status page\n            session[\"last_booking_ids\"] = new_booking_ids\n            return redirect(url_for(\"booking_submitted\"))\n\n        except Exception as e:\n            if conn:\n                conn.rollback()\n                print(f\"Booking POST Error: {e}\")\n            return f\"Error processing booking: {e}\", 500\n        finally:\n            if conn:\n                conn.close()\n\n    # --- GET REQUEST: Render Form ---\n    conn = None\n    try:\n        conn = get_db_connection()\n        cur = conn.cursor()\n\n        # 1. Fetch Active Courses\n        print(\"DEBUG: Fetching active courses...\")\n        cur.execute(\"\"\"\n            SELECT course_id, course_name, description\n            FROM courses\n            WHERE active = TRUE\n            ORDER BY course_name\n        \"\"\")\n        courses_data = cur.fetchall()\n        print(f\"DEBUG: Found {len(courses_data)} active courses.\")\n\n        # 2. Fetch Active Modules\n        cur.execute(\"\"\"\n            SELECT module_id, course_id, module_name, module_description\n            FROM course_modules\n            WHERE active = TRUE\n            ORDER BY module_order\n        \"\"\")\n        modules_data = cur.fetchall()\n\n        cur.close()\n        conn.close()\n\n        # 3. Organize Data\n        modules_by_course = {}\n        for m in modules_data:\n            m_id, m_course_id, m_name, m_desc = m\n            if m_course_id not in modules_by_course:\n                modules_by_course[m_course_id] = []\n            modules_by_course[m_course_id].append({\n                \"id\": m_id,\n                \"name\": m_name,\n                \"description\": m_desc\n            })\n\n        courses_payload = []\n        for c in courses_data:\n            c_id, c_name, c_desc = c\n            courses_payload.append({\n                \"id\": c_id,\n                \"name\": c_name,\n                \"description\": c_desc,\n                \"modules\": modules_by_course.get(c_id, [])\n            })\n\n        return render_template(\n            \"booking.html\",\n            user={\n                \"name\": session.get(\"name\"),\n                \"email\": session.get(\"email\"),\n                \"phone\": session.get(\"phone\"),\n            },\n            courses=courses_payload  # &lt;--- CRITICAL: Passing data to template\n        )\n\n    except Exception as e:\n        print(f\"Booking GET Error: {e}\")\n        return f\"Error loading booking page: {e}\", 500\n    finally:\n        if conn:\n            conn.close()\n</code></pre>"},{"location":"#app.booking_submitted","title":"<code>booking_submitted()</code>","text":"<p>Display booking confirmation page.</p> <p>Shows the details of the most recently submitted booking. Requires authentication.</p> <p>Returns:</p> Name Type Description <code>str</code> <p>Rendered booking confirmation template or redirect</p> Source code in <code>app.py</code> <pre><code>@app.route(\"/booking-submitted\")\ndef booking_submitted():\n    \"\"\"\n    Display booking confirmation page.\n\n    Shows the details of the most recently submitted booking.\n    Requires authentication.\n\n    Returns:\n        str: Rendered booking confirmation template or redirect\n    \"\"\"\n    if session.get(\"role\") != \"customer\":\n        return redirect(url_for(\"customer_login\"))\n\n    # Get IDs from Session\n    booking_ids = session.get(\"last_booking_ids\")\n    if not booking_ids:\n        return redirect(url_for(\"booking\"))\n\n    booking_details = []\n\n    conn = None\n    try:\n        conn = get_db_connection()\n        cur = conn.cursor()\n\n        # Fetch Course &amp; Extra Info for bookings\n        # use ANY(%s) to match any ID in the list\n        cur.execute(\"\"\"\n            SELECT b.booking_id, c.course_name, b.nice_to_have_requests\n            FROM bookings b\n            JOIN courses c ON b.course_id = c.course_id\n            WHERE b.booking_id = ANY(%s)\n        \"\"\", (booking_ids,))\n\n        rows = cur.fetchall()\n\n        for row in rows:\n            b_id, c_name, extra = row\n\n            # Fetch Modules for this specific booking\n            cur.execute(\"\"\"\n                SELECT m.module_name\n                FROM booking_modules bm\n                JOIN modules m ON bm.module_id = m.module_id\n                WHERE bm.booking_id = %s\n            \"\"\", (b_id,))\n\n            modules = [m[0] for m in cur.fetchall()]\n\n            booking_details.append({\n                \"course\": c_name,\n                \"modules\": modules,\n                \"extra\": extra\n            })\n\n        cur.close()\n        conn.close()\n\n    except Exception as e:\n        print(f\"Error fetching confirmation: {e}\")\n        if conn:\n            conn.close()\n        return \"Error loading confirmation\", 500\n\n    return render_template(\n        \"booking_submitted.html\",\n        bookings=booking_details  # Pass list of booking objects\n    )\n</code></pre>"},{"location":"#app.customer_dashboard","title":"<code>customer_dashboard()</code>","text":"<p>Display customer dashboard with personal details and bookings.</p> Source code in <code>app.py</code> <pre><code>@app.route(\"/dashboard\", methods=[\"GET\", \"POST\"])\ndef customer_dashboard():\n    \"\"\"\n    Display customer dashboard with personal details and bookings.\n    \"\"\"\n    if session.get(\"role\") != \"customer\":\n        return redirect(url_for(\"customer_login\"))\n\n    user_email = session.get(\"email\")\n\n    if request.method == \"POST\":\n        # 1. Validate Form Data\n        course_id_to_update = request.form.get(\"course\")\n        new_extra = request.form.get(\"extra\")\n\n        if not course_id_to_update:\n            return \"Missing course ID\", 400\n\n        conn = None\n        cursor = None\n        try:\n            conn = get_db_connection()\n            cursor = conn.cursor()\n\n            # 2. Perform Update\n            update_query = \"\"\"\n            UPDATE bookings\n            SET nice_to_have_requests = %s, updated_at = NOW()\n            FROM customers c\n            WHERE bookings.customer_id = c.customer_id\n            AND c.email = %s\n            AND bookings.course_id = %s\n            \"\"\"\n            cursor.execute(update_query, (new_extra, user_email, course_id_to_update))\n            conn.commit()\n\n        except Exception as e:\n            if conn:\n                conn.rollback()\n            print(f\"Update Error: {e}\")\n            return f\"Error updating booking: {e}\", 500\n        finally:\n            # 3. Safe Cleanup\n            if cursor:\n                cursor.close()\n            if conn:\n                conn.close()\n\n        # Redirect to GET after POST (PRG Pattern) to prevent resubmission\n        return redirect(url_for(\"customer_dashboard\"))\n\n    # --- GET Request Handling ---\n\n    personal_details = {\n        \"name\": session.get(\"name\"),\n        \"email\": session.get(\"email\"),\n        \"phone\": session.get(\"phone\"),\n    }\n\n    conn = None\n    cursor = None\n    user_bookings = []\n\n    try:\n        conn = get_db_connection()\n        cursor = conn.cursor()\n\n        query = \"\"\"\n        SELECT\n            b.booking_id,\n            b.course_id,\n            b.nice_to_have_requests,\n            b.status,\n            co.course_name,\n            co.description\n        FROM bookings b\n        JOIN customers c ON b.customer_id = c.customer_id\n        JOIN courses co ON b.course_id = co.course_id\n        WHERE c.email = %s\n        ORDER BY b.booking_id DESC\n        \"\"\"\n        cursor.execute(query, (user_email,))\n        rows = cursor.fetchall()\n\n        for row in rows:\n            user_bookings.append({\n                \"booking_id\": row[0],\n                \"course_id\": row[1],\n                \"extra\": row[2],\n                \"status\": row[3],\n                \"course\": row[4],\n                \"description\": row[5]\n            })\n\n    except Exception as e:\n        print(f\"Dashboard Fetch Error: {e}\")\n        return f\"Error fetching dashboard: {e}\", 500\n    finally:\n        if cursor:\n            cursor.close()\n        if conn:\n            conn.close()\n\n    return render_template(\n        \"customer_dashboard.html\",\n        personal_details=personal_details,\n        bookings=user_bookings,\n    )\n</code></pre>"},{"location":"#app.customer_login","title":"<code>customer_login()</code>","text":"<p>Handle customer login.</p> <p>GET: Display the login form POST: Process login credentials and create session</p> <p>Returns:</p> Name Type Description <code>str</code> <p>login template or redirect to dashboard POST</p> Source code in <code>app.py</code> <pre><code>@app.route(\"/login\", methods=[\"GET\", \"POST\"])\ndef customer_login():\n    \"\"\"\n    Handle customer login.\n\n    GET: Display the login form\n    POST: Process login credentials and create session\n\n    Returns:\n        str: login template or redirect to dashboard POST\n    \"\"\"\n    # POST checks password and fails or redirects to dashboard\n    if request.method == \"POST\":\n        email = request.form[\"email\"]\n        password = request.form[\"password\"]\n\n        # Read DB and check if we can find user\n        # Look up user in the database\n        try:\n            conn = get_db_connection()\n            cur = conn.cursor()\n            cur.execute(\n                \"\"\"\n                SELECT customer_id, name, last_name, email, phone, password\n                FROM customers\n                WHERE email = %s\n                \"\"\",\n                (email,),\n            )\n            row = cur.fetchone()\n            cur.close()\n            conn.close()\n        except Exception:\n            # For production, log this and show generic error\n            return \"Invalid login credentials\", 401\n        # check if row cursor was successful proceed else fail\n        if not row:\n            return \"Invalid login credentials\"\n        # success extract row data to variables\n        customer_id, first_name, last_name, email_db, phone, s_password = row\n        # Check if password matched else fail\n        if s_password != password:\n            return \"Invalid login credentials\"\n        # create full name varible and concantenate first and last name with space for memory db\n        name = f\"{first_name} {last_name}\"\n\n        # Set in memory array values\n        CUSTOMERS[email_db] = {\n            \"password\": s_password,\n            \"name\": name,\n            \"email\": email_db,\n            \"phone\": phone,\n        }\n        # Set session values used elsewhere\n        session[\"user\"] = email_db\n        session[\"role\"] = \"customer\"\n        session[\"name\"] = name\n        session[\"email\"] = email_db\n        session[\"phone\"] = phone\n\n        return redirect(url_for(\"customer_dashboard\"))\n    # GET sends login\n    return render_template(\"customer_login.html\")\n</code></pre>"},{"location":"#app.edit_booking","title":"<code>edit_booking(booking_id)</code>","text":"<p>Handle editing of bookings in admin panel.</p> <p>GET: Display the edit booking form POST: Process booking updates</p> <p>Parameters:</p> Name Type Description Default <code>booking_id</code> <code>int</code> <p>The ID of the booking to edit</p> required <p>Returns:</p> Name Type Description <code>str</code> <p>Rendered edit template or redirect to admin dashboard</p> Source code in <code>app.py</code> <pre><code>@app.route(\"/admin/bookings/&lt;int:booking_id&gt;/edit\", methods=[\"GET\", \"POST\"])\ndef edit_booking(booking_id):\n    \"\"\"\n    Handle editing of bookings in admin panel.\n\n    GET: Display the edit booking form\n    POST: Process booking updates\n\n    Args:\n        booking_id (int): The ID of the booking to edit\n\n    Returns:\n        str: Rendered edit template or redirect to admin dashboard\n    \"\"\"\n\n    if request.method == \"POST\":\n        return redirect(url_for(\"admin_dashboard\"))\n\n    return render_template(\"edit_booking.html\", booking_id=booking_id)\n</code></pre>"},{"location":"#app.get_db_connection","title":"<code>get_db_connection()</code>","text":"<p>Parse DATABASE_URL (from Docker Compose) and connect securely.</p> Source code in <code>app.py</code> <pre><code>def get_db_connection():\n    \"\"\"\n    Parse DATABASE_URL (from Docker Compose) and connect securely.\n    \"\"\"\n    database_url = os.environ.get(\"DATABASE_URL\")\n    if not database_url:\n        raise ValueError(\"DATABASE_URL environment variable is required\")\n\n    # Parse postgresql://user:pass@host:port/dbname\n    parsed = urlparse(database_url)\n\n    return psycopg2.connect(\n        host=parsed.hostname,\n        port=parsed.port or 5432,\n        dbname=parsed.path[1:],  # Remove leading '/'\n        user=parsed.username,\n        password=parsed.password,\n    )\n</code></pre>"},{"location":"#app.index","title":"<code>index()</code>","text":"<p>Render the landing page.</p> <p>Returns:</p> Name Type Description <code>str</code> <p>Rendered HTML template for the index page</p> Source code in <code>app.py</code> <pre><code>@app.route(\"/\")\ndef index():\n    \"\"\"\n    Render the landing page.\n\n    Returns:\n        str: Rendered HTML template for the index page\n    \"\"\"\n    return render_template(\"index.html\")\n</code></pre>"},{"location":"#app.logout","title":"<code>logout()</code>","text":"<p>Log out the current user by clearing the session.</p> <p>Returns:</p> Type Description <p>werkzeug.wrappers.Response: Redirect to login page</p> Source code in <code>app.py</code> <pre><code>@app.route(\"/logout\")\ndef logout():\n    \"\"\"\n    Log out the current user by clearing the session.\n\n    Returns:\n        werkzeug.wrappers.Response: Redirect to login page\n    \"\"\"\n    session.clear()\n    return redirect(url_for(\"customer_login\"))\n</code></pre>"},{"location":"#app.register","title":"<code>register()</code>","text":"<p>Handle customer registration.</p> <p>GET: Display the registration form POST: Process registration and create new customer account</p> <p>Returns:</p> Name Type Description <code>str</code> <p>Rendered registration template or redirect to login</p> Source code in <code>app.py</code> <pre><code>@app.route(\"/register\", methods=[\"GET\", \"POST\"])\ndef register():\n    \"\"\"\n    Handle customer registration.\n\n    GET: Display the registration form\n    POST: Process registration and create new customer account\n\n    Returns:\n        str: Rendered registration template or redirect to login\n    \"\"\"\n    if request.method == \"POST\":\n        first_name = request.form[\"first_name\"]\n        last_name = request.form[\"last_name\"]\n        name = first_name + \" \" + last_name\n        email = request.form[\"email\"]\n        phone = request.form[\"phone\"]\n        password = request.form[\"password\"]\n        confirm_password = request.form[\"confirm_password\"]\n\n        # Check passwords match\n        if password != confirm_password:\n            return \"Passwords do not match\"\n\n        # Save new user in memory\n        CUSTOMERS[email] = {\n            \"password\": password,\n            \"name\": name,\n            \"email\": email,\n            \"phone\": \"N/A\",\n        }\n        # Insert into customers table\n        try:\n            conn = get_db_connection()\n            cur = conn.cursor()\n            cur.execute(\n                \"\"\"\n                INSERT INTO customers (name, last_name, email, phone, created_at, password)\n                VALUES (%s, %s, %s, %s, CURRENT_TIMESTAMP, %s)\n                \"\"\",\n                (first_name, last_name, email, phone, password),\n            )\n            conn.commit()\n            cur.close()\n            conn.close()\n        except Exception as e:\n            # For production, log this instead of returning raw error\n            return f\"Error creating account: {e}\", 500\n\n        return redirect(url_for(\"customer_login\"))\n\n    return render_template(\"register.html\")\n</code></pre>"},{"location":"databasetables/","title":"Databasetables","text":"<p>Password for user ghibli_adm: psql (16.11 (Ubuntu 16.11-0ubuntu0.24.04.1)) SSL connection (protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, compression: off) Type \"help\" for help.</p> <p>ghibli_booking=&gt; CREATE TYPE booking_status AS ENUM ('pending', 'approved', 'cancelled'); CREATE TYPE admin_role AS ENUM ('admin', 'editor', 'viewer'); CREATE TYPE CREATE TYPE ghibli_booking=&gt; CREATE TABLE customers (   customer_id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,   first_name  TEXT NOT NULL,   last_name   TEXT NOT NULL,   email       TEXT NOT NULL UNIQUE,   phone       TEXT,   created_at  TIMESTAMPTZ NOT NULL DEFAULT now() ); CREATE TABLE ghibli_booking=&gt; CREATE TABLE admins (   admin_id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,   name     TEXT NOT NULL,   email    TEXT NOT NULL,   role     TEXT NOT NULL ); CREATE TABLE ghibli_booking=&gt; CREATE TABLE courses (   course_id    BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,   course_name  TEXT NOT NULL UNIQUE,   description  TEXT NOT NULL,   active       BOOLEAN NOT NULL DEFAULT true,   created_at   TIMESTAMPTZ NOT NULL DEFAULT now() ); CREATE TABLE ghibli_booking=&gt; CREATE TABLE course_modules (   module_id          BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,   course_id          BIGINT NOT NULL,   module_name        TEXT NOT NULL,   module_description TEXT,   module_order       INTEGER,   active             BOOLEAN NOT NULL DEFAULT true,   CONSTRAINT fk_course_modules_course     FOREIGN KEY (course_id) REFERENCES courses(course_id) ); CREATE TABLE ghibli_booking=&gt; CREATE TABLE bookings (   booking_id             BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,   customer_id            BIGINT NOT NULL,   course_id              BIGINT NOT NULL,   nice_to_have_requests  TEXT,   status                 TEXT NOT NULL,   locked                 BOOLEAN NOT NULL DEFAULT false,   submitted_at           TIMESTAMPTZ NOT NULL DEFAULT now(),   updated_at             TIMESTAMPTZ NOT NULL DEFAULT now(),   CONSTRAINT fk_bookings_customer     FOREIGN KEY (customer_id) REFERENCES customers(customer_id),   CONSTRAINT fk_bookings_course     FOREIGN KEY (course_id) REFERENCES courses(course_id) ); CREATE TABLE ghibli_booking=&gt; CREATE TABLE booking_modules (   booking_id BIGINT NOT NULL,   module_id  BIGINT NOT NULL,   PRIMARY KEY (booking_id, module_id),   CONSTRAINT fk_booking_modules_booking     FOREIGN KEY (booking_id) REFERENCES bookings(booking_id),   CONSTRAINT fk_booking_modules_module     FOREIGN KEY (module_id) REFERENCES course_modules(module_id) ); CREATE TABLE</p>"}]}